{
    "$schema":  "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion":  "1.0.0.0",
    "triggers":  {
                     "Recurrence":  {
                                        "type":  "Recurrence",
                                        "recurrence":  {
                                                           "interval":  12,
                                                           "frequency":  "Hour"
                                                       }
                                    }
                 },
    "actions":  {
                    "Get_items":  {
                                      "type":  "ApiConnection",
                                      "inputs":  {
                                                     "host":  {
                                                                  "connection":  {
                                                                                     "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                 }
                                                              },
                                                     "method":  "get",
                                                     "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items",
                                                     "queries":  {
                                                                     "$filter":  "(InviteStatus eq \u0027Pending\u0027) or (InviteStatus eq \u0027Sent\u0027) or (InviteStatus eq \u0027Active\u0027)"
                                                                 }
                                                 },
                                      "runAfter":  {

                                                   }
                                  },
                    "For_each_user":  {
                                          "type":  "Foreach",
                                          "foreach":  "@body(\u0027Get_items\u0027)?[\u0027value\u0027]",
                                          "actions":  {
                                                          "Get_user":  {
                                                                           "type":  "ApiConnection",
                                                                           "inputs":  {
                                                                                          "host":  {
                                                                                                       "connection":  {
                                                                                                                          "name":  "@parameters(\u0027$connections\u0027)[\u0027azuread\u0027][\u0027connectionId\u0027]"
                                                                                                                      }
                                                                                                   },
                                                                                          "method":  "get",
                                                                                          "path":  "/v1.0/users/@{encodeURIComponent(item()?[\u0027Title\u0027])}"
                                                                                      }
                                                                       },
                                                          "Update_Display_Name":  {
                                                                                      "type":  "ApiConnection",
                                                                                      "inputs":  {
                                                                                                     "host":  {
                                                                                                                  "connection":  {
                                                                                                                                     "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                 }
                                                                                                              },
                                                                                                     "method":  "patch",
                                                                                                     "body":  {
                                                                                                                  "DisplayName":  "@{body(\u0027Get_user\u0027)?[\u0027displayName\u0027]}"
                                                                                                              },
                                                                                                     "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                 },
                                                                                      "runAfter":  {
                                                                                                       "Get_user":  [
                                                                                                                        "Succeeded"
                                                                                                                    ]
                                                                                                   }
                                                                                  },
                                                          "Check_MFA_Status":  {
                                                                                   "type":  "Http",
                                                                                   "inputs":  {
                                                                                                  "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/methods",
                                                                                                  "method":  "GET",
                                                                                                  "authentication":  {
                                                                                                                         "type":  "ManagedServiceIdentity",
                                                                                                                         "audience":  "https://graph.microsoft.com"
                                                                                                                     }
                                                                                              },
                                                                                   "runAfter":  {
                                                                                                    "Get_user":  [
                                                                                                                     "Succeeded"
                                                                                                                 ]
                                                                                                }
                                                                               },
                                                          "Check_Group_Membership":  {
                                                                                         "type":  "Http",
                                                                                         "inputs":  {
                                                                                                        "uri":  "https://graph.microsoft.com/v1.0/groups/2db39251-1b4c-4c90-a920-1e16debc9264/members/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}",
                                                                                                        "method":  "GET",
                                                                                                        "authentication":  {
                                                                                                                               "type":  "ManagedServiceIdentity",
                                                                                                                               "audience":  "https://graph.microsoft.com"
                                                                                                                           }
                                                                                                    },
                                                                                         "runAfter":  {
                                                                                                          "Get_user":  [
                                                                                                                           "Succeeded"
                                                                                                                       ]
                                                                                                      }
                                                                                     },
                                                          "Parse_MFA_Methods":  {
                                                                                    "type":  "ParseJson",
                                                                                    "inputs":  {
                                                                                                   "content":  "@body(\u0027Check_MFA_Status\u0027)",
                                                                                                   "schema":  {
                                                                                                                  "type":  "object",
                                                                                                                  "properties":  {
                                                                                                                                     "value":  {
                                                                                                                                                   "type":  "array",
                                                                                                                                                   "items":  {
                                                                                                                                                                 "type":  "object"
                                                                                                                                                             }
                                                                                                                                               }
                                                                                                                                 }
                                                                                                              }
                                                                                               },
                                                                                    "runAfter":  {
                                                                                                     "Check_MFA_Status":  [
                                                                                                                              "Succeeded"
                                                                                                                          ]
                                                                                                 }
                                                                                },
                                                          "Update_Last_Checked":  {
                                                                                      "type":  "ApiConnection",
                                                                                      "inputs":  {
                                                                                                     "host":  {
                                                                                                                  "connection":  {
                                                                                                                                     "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                 }
                                                                                                              },
                                                                                                     "method":  "patch",
                                                                                                     "body":  {
                                                                                                                  "LastChecked":  "@{utcNow()}"
                                                                                                              },
                                                                                                     "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                 },
                                                                                      "runAfter":  {
                                                                                                       "Parse_MFA_Methods":  [
                                                                                                                                 "Succeeded"
                                                                                                                             ]
                                                                                                   }
                                                                                  },
                                                          "Check_Group_Membership_Status":  {
                                                                                                "type":  "If",
                                                                                                "expression":  {
                                                                                                                   "and":  [
                                                                                                                               {
                                                                                                                                   "equals":  [
                                                                                                                                                  "@outputs(\u0027Check_Group_Membership\u0027)[\u0027statusCode\u0027]",
                                                                                                                                                  200
                                                                                                                                              ]
                                                                                                                               }
                                                                                                                           ]
                                                                                                               },
                                                                                                "actions":  {
                                                                                                                "Check_if_MFA_registered":  {
                                                                                                                                                "type":  "If",
                                                                                                                                                "expression":  {
                                                                                                                                                                   "or":  [
                                                                                                                                                                              {
                                                                                                                                                                                  "contains":  [
                                                                                                                                                                                                   "@string(body(\u0027Parse_MFA_Methods\u0027)?[\u0027value\u0027])",
                                                                                                                                                                                                   "phoneAuthenticationMethod"
                                                                                                                                                                                               ]
                                                                                                                                                                              },
                                                                                                                                                                              {
                                                                                                                                                                                  "contains":  [
                                                                                                                                                                                                   "@string(body(\u0027Parse_MFA_Methods\u0027)?[\u0027value\u0027])",
                                                                                                                                                                                                   "microsoftAuthenticatorAuthenticationMethod"
                                                                                                                                                                                               ]
                                                                                                                                                                              },
                                                                                                                                                                              {
                                                                                                                                                                                  "contains":  [
                                                                                                                                                                                                   "@string(body(\u0027Parse_MFA_Methods\u0027)?[\u0027value\u0027])",
                                                                                                                                                                                                   "softwareOathAuthenticationMethod"
                                                                                                                                                                                               ]
                                                                                                                                                                              }
                                                                                                                                                                          ]
                                                                                                                                                               },
                                                                                                                                                "actions":  {
                                                                                                                                                                "Update_MFA_Active":  {
                                                                                                                                                                                          "type":  "ApiConnection",
                                                                                                                                                                                          "inputs":  {
                                                                                                                                                                                                         "host":  {
                                                                                                                                                                                                                      "connection":  {
                                                                                                                                                                                                                                         "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                  },
                                                                                                                                                                                                         "method":  "patch",
                                                                                                                                                                                                         "body":  {
                                                                                                                                                                                                                      "InviteStatus":  {
                                                                                                                                                                                                                                           "Value":  "Active"
                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                      "MFARegistrationState":  {
                                                                                                                                                                                                                                                   "Value":  "Registered"
                                                                                                                                                                                                                                               },
                                                                                                                                                                                                                      "InGroup":  true
                                                                                                                                                                                                                  },
                                                                                                                                                                                                         "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                     }
                                                                                                                                                                                      }
                                                                                                                                                            },
                                                                                                                                                "else":  {
                                                                                                                                                             "actions":  {
                                                                                                                                                                             "Update_MFA_Not_Registered":  {
                                                                                                                                                                                                               "type":  "ApiConnection",
                                                                                                                                                                                                               "inputs":  {
                                                                                                                                                                                                                              "host":  {
                                                                                                                                                                                                                                           "connection":  {
                                                                                                                                                                                                                                                              "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                              "method":  "patch",
                                                                                                                                                                                                                              "body":  {
                                                                                                                                                                                                                                           "MFARegistrationState":  {
                                                                                                                                                                                                                                                                        "Value":  "Not Registered"
                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                           "InGroup":  true
                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                              "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                                          }
                                                                                                                                                                                                           },
                                                                                                                                                                             "Check_if_first_email":  {
                                                                                                                                                                                                          "type":  "If",
                                                                                                                                                                                                          "expression":  {
                                                                                                                                                                                                                             "and":  [
                                                                                                                                                                                                                                         {
                                                                                                                                                                                                                                             "equals":  [
                                                                                                                                                                                                                                                            "@item()?[\u0027InviteStatus\u0027]?[\u0027Value\u0027]",
                                                                                                                                                                                                                                                            "Pending"
                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                     ]
                                                                                                                                                                                                                         },
                                                                                                                                                                                                          "actions":  {
                                                                                                                                                                                                                          "Send_initial_email":  {
                                                                                                                                                                                                                                                     "type":  "ApiConnection",
                                                                                                                                                                                                                                                     "inputs":  {
                                                                                                                                                                                                                                                                    "host":  {
                                                                                                                                                                                                                                                                                 "connection":  {
                                                                                                                                                                                                                                                                                                    "name":  "@parameters(\u0027$connections\u0027)[\u0027office365-1\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                                                    "method":  "post",
                                                                                                                                                                                                                                                                    "body":  {
                                                                                                                                                                                                                                                                                 "MailboxAddress":  "MFA-Registration@andykemp.com",
                                                                                                                                                                                                                                                                                 "To":  "@{item()?[\u0027Title\u0027]}",
                                                                                                                                                                                                                                                                                 "Subject":  "üîí Action Required: Set Up Multi-Factor Authentication (MFA)",
                                                                                                                                                                                                                                                                                 "Body":  "\u003chtml\u003e\u003chead\u003e\u003cstyle\u003ebody{font-family:\u0027Segoe UI\u0027,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background-color:#f4f4f4}.container{max-width:600px;margin:40px auto;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.logo-header{background:#fff;padding:15px;text-align:center;border-bottom:1px solid #e0e0e0}.logo-header img{max-width:200px;height:auto}.header{background:#0078D4;padding:30px 20px;text-align:center}.header h1{color:#fff;margin:0;font-size:26px;font-weight:600}.content{padding:30px 30px 20px}.greeting{font-size:16px;color:#333;margin-bottom:15px}.message{font-size:15px;line-height:1.6;color:#555;margin-bottom:20px}.deadline-box{background:#ffe8e8;border-left:4px solid #dc3545;padding:15px 20px;margin:20px 0;border-radius:4px}.deadline-box strong{color:#dc3545}.steps{background:#f8f9fa;padding:20px;border-radius:6px;margin:20px 0}.steps h3{color:#0078D4;margin-top:0;font-size:18px}.steps ol{margin:10px 0;padding-left:20px}.steps li{margin:8px 0;color:#555}.app-links{text-align:center;margin:25px 0;padding:20px;background:#f8f9fa;border-radius:6px}.app-links h4{color:#333;margin-bottom:15px;font-size:16px}.app-links a{display:inline-block;margin:5px 8px;vertical-align:middle}.app-links img{height:45px;width:auto;display:inline-block;vertical-align:middle}.footer{background:#f8f9fa;padding:20px 30px;text-align:center;color:#888;font-size:13px}\u003c/style\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv class=\u0027container\u0027\u003e\u003cdiv class=\u0027logo-header\u0027\u003e\u003cimg src=\u0027https://www.cygnetgroup.com/wp-content/uploads/2015/11/new-news-image.jpg\u0027 alt=\u0027Cygnet Group\u0027/\u003e\u003c/div\u003e\u003cdiv class=\u0027header\u0027\u003e\u003ch1\u003eMulti-Factor Authentication Setup Required\u003c/h1\u003e\u003c/div\u003e\u003cdiv class=\u0027content\u0027\u003e\u003cdiv class=\u0027greeting\u0027\u003eDear \u003cstrong\u003e@{body(\u0027Get_user\u0027)?[\u0027displayName\u0027]}\u003c/strong\u003e,\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eAs part of our commitment to protecting your account and company data, we require all users to enable Multi-Factor Authentication (MFA). This adds an extra layer of security to your account.\u003c/div\u003e\u003cdiv class=\u0027deadline-box\u0027\u003e\u003cstrong\u003e‚è∞ Important:\u003c/strong\u003e Please complete your MFA setup within the next \u003cstrong\u003e7 days\u003c/strong\u003e.\u003c/div\u003e\u003cdiv class=\u0027steps\u0027\u003e\u003ch3\u003eüì± How to Set Up MFA (4 Easy Steps):\u003c/h3\u003e\u003col\u003e\u003cli\u003e\u003cstrong\u003eClick the button below\u003c/strong\u003e to start the setup process\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eDownload Microsoft Authenticator\u003c/strong\u003e on your mobile device (links below)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eFollow the on-screen instructions\u003c/strong\u003e to link your account\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eYou\u0027re done!\u003c/strong\u003e Your account is now secure\u003c/li\u003e\u003c/ol\u003e\u003c/div\u003e\u003cdiv style=\u0027text-align:center;margin:25px 0\u0027\u003e\u003ctable cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;margin:0 auto\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;padding:16px 45px\u0027\u003e\u003ca href=\u0027https://func-mfa-enrol-570670.azurewebsites.net/api/track-mfa-click?user=@{encodeUriComponent(item()?[\u0027Title\u0027])}\u0027 target=\u0027_blank\u0027 style=\u0027font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;display:inline-block\u0027\u003e\u003cspan style=\u0027color:#ffffff;font-size:16px;font-weight:600\u0027\u003eüöÄ Set Up MFA Now\u003c/span\u003e\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/div\u003e\u003cdiv class=\u0027app-links\u0027\u003e\u003ch4\u003eüì≤ Download Microsoft Authenticator:\u003c/h4\u003e\u003ca href=\u0027https://apps.apple.com/app/microsoft-authenticator/id983156458\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg\u0027 alt=\u0027App Store\u0027/\u003e\u003c/a\u003e\u003ca href=\u0027https://play.google.com/store/apps/details?id=com.azure.authenticator\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png\u0027 alt=\u0027Google Play\u0027/\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eIf you have any questions or need assistance, please contact the IT Security Team.\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\u0027footer\u0027\u003eThis is an automated message from IT Security Team\u003cbr\u003e¬© @{utcNow(\u0027yyyy\u0027)} Your Organization. All rights reserved.\u003c/div\u003e\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e",
                                                                                                                                                                                                                                                                                 "Importance":  "High"
                                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                                                    "path":  "/v2/SharedMailbox/Mail"
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                          "Update_After_Initial_Email":  {
                                                                                                                                                                                                                                                             "type":  "ApiConnection",
                                                                                                                                                                                                                                                             "inputs":  {
                                                                                                                                                                                                                                                                            "host":  {
                                                                                                                                                                                                                                                                                         "connection":  {
                                                                                                                                                                                                                                                                                                            "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                                                            "method":  "patch",
                                                                                                                                                                                                                                                                            "body":  {
                                                                                                                                                                                                                                                                                         "InviteStatus":  {
                                                                                                                                                                                                                                                                                                              "Value":  "Sent"
                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                         "InviteSentDate":  "@{utcNow()}",
                                                                                                                                                                                                                                                                                         "ReminderCount":  1
                                                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                                                            "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                             "runAfter":  {
                                                                                                                                                                                                                                                                              "Send_initial_email":  [
                                                                                                                                                                                                                                                                                                         "Succeeded"
                                                                                                                                                                                                                                                                                                     ]
                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                      },
                                                                                                                                                                                                          "else":  {
                                                                                                                                                                                                                       "actions":  {
                                                                                                                                                                                                                                       "Check_if_7_days_passed":  {
                                                                                                                                                                                                                                                                      "type":  "If",
                                                                                                                                                                                                                                                                      "expression":  {
                                                                                                                                                                                                                                                                                         "or":  [
                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                        "equals":  [
                                                                                                                                                                                                                                                                                                                       "@item()?[\u0027LastReminderDate\u0027]",
                                                                                                                                                                                                                                                                                                                       "@null"
                                                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                        "lessOrEquals":  [
                                                                                                                                                                                                                                                                                                                             "@addDays(item()?[\u0027LastReminderDate\u0027], 7)",
                                                                                                                                                                                                                                                                                                                             "@utcNow()"
                                                                                                                                                                                                                                                                                                                         ]
                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                ]
                                                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                                                      "actions":  {
                                                                                                                                                                                                                                                                                      "Send_reminder_email":  {
                                                                                                                                                                                                                                                                                                                  "type":  "ApiConnection",
                                                                                                                                                                                                                                                                                                                  "inputs":  {
                                                                                                                                                                                                                                                                                                                                 "host":  {
                                                                                                                                                                                                                                                                                                                                              "connection":  {
                                                                                                                                                                                                                                                                                                                                                                 "name":  "@parameters(\u0027$connections\u0027)[\u0027office365-1\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                 "method":  "post",
                                                                                                                                                                                                                                                                                                                                 "body":  {
                                                                                                                                                                                                                                                                                                                                              "MailboxAddress":  "MFA-Registration@andykemp.com",
                                                                                                                                                                                                                                                                                                                                              "To":  "@{item()?[\u0027Title\u0027]}",
                                                                                                                                                                                                                                                                                                                                              "Subject":  "‚ö†Ô∏è Reminder #@{item()?[\u0027ReminderCount\u0027]}: MFA Setup Still Pending",
                                                                                                                                                                                                                                                                                                                                              "Body":  "\u003chtml\u003e\u003chead\u003e\u003cmeta charset=\u0027UTF-8\u0027\u003e\u003cmeta name=\u0027viewport\u0027 content=\u0027width=device-width,initial-scale=1.0\u0027\u003e\u003cstyle\u003ea{text-decoration:none!important}\u003c/style\u003e\u003c/head\u003e\u003cbody style=\u0027font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background-color:#f4f4f4\u0027\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background-color:#f4f4f4;padding:20px 0\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027\u003e\u003ctable width=\u0027600\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)\u0027\u003e\u003ctr\u003e\u003ctd style=\u0027background:#fff;padding:15px;text-align:center;border-bottom:1px solid #e0e0e0\u0027\u003e\u003cimg src=\u0027https://www.cygnetgroup.com/wp-content/uploads/2015/11/new-news-image.jpg\u0027 alt=\u0027Cygnet Group\u0027 style=\u0027max-width:200px;height:auto\u0027/\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\u0027background:#0078D4;padding:30px 20px;text-align:center\u0027\u003e\u003ch1 style=\u0027color:#ffffff;margin:0;font-size:26px;font-weight:600\u0027\u003eMFA Setup Reminder\u003c/h1\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\u0027padding:30px\u0027\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027margin:0 0 20px\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027\u003e\u003ctable cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background:#0078D4;border-radius:20px\u0027\u003e\u003ctr\u003e\u003ctd style=\u0027padding:8px 20px\u0027\u003e\u003cspan style=\u0027color:#ffffff;font-size:14px;font-weight:600\u0027\u003eReminder #@{item()?[\u0027ReminderCount\u0027]}\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003cp style=\u0027font-size:16px;color:#333;margin:0 0 15px\u0027\u003eDear \u003cstrong\u003e@{body(\u0027Get_user\u0027)?[\u0027displayName\u0027]}\u003c/strong\u003e,\u003c/p\u003e\u003cp style=\u0027font-size:15px;line-height:1.6;color:#555;margin:0 0 20px\u0027\u003eWe noticed that you have not yet completed your Multi-Factor Authentication (MFA) setup. Securing your account is critical for protecting company data and your personal information.\u003c/p\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background:#ffe8e8;border-left:4px solid #dc3545;margin:20px 0;border-radius:4px\u0027\u003e\u003ctr\u003e\u003ctd style=\u0027padding:15px 20px\u0027\u003e\u003cp style=\u0027margin:0;font-size:15px;color:#721c24\u0027\u003e\u003cstrong\u003e‚è∞ Important:\u003c/strong\u003e Your MFA setup was due \u003cstrong\u003e7 days ago\u003c/strong\u003e. Please complete this setup immediately to maintain access to company resources.\u003c/p\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background:#f8f9fa;margin:20px 0;border-radius:6px\u0027\u003e\u003ctr\u003e\u003ctd style=\u0027padding:20px\u0027\u003e\u003ch3 style=\u0027color:#0078D4;margin:0 0 15px;font-size:18px\u0027\u003eüì± Quick Setup Guide:\u003c/h3\u003e\u003col style=\u0027margin:10px 0;padding-left:20px;color:#555\u0027\u003e\u003cli style=\u0027margin:8px 0\u0027\u003e\u003cstrong\u003eClick the button below\u003c/strong\u003e to begin\u003c/li\u003e\u003cli style=\u0027margin:8px 0\u0027\u003e\u003cstrong\u003eDownload Microsoft Authenticator\u003c/strong\u003e (if not already installed)\u003c/li\u003e\u003cli style=\u0027margin:8px 0\u0027\u003e\u003cstrong\u003eScan the QR code\u003c/strong\u003e with your phone\u003c/li\u003e\u003cli style=\u0027margin:8px 0\u0027\u003e\u003cstrong\u003eComplete verification\u003c/strong\u003e - Done in 2 minutes!\u003c/li\u003e\u003c/ol\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027margin:30px 0\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027\u003e\u003ctable cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;padding:16px 45px\u0027\u003e\u003ca href=\u0027https://func-mfa-enrol-327138.azurewebsites.net/api/track-mfa-click?user=@{encodeUriComponent(item()?[\u0027Title\u0027])}\u0027 target=\u0027_blank\u0027 style=\u0027font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;display:inline-block\u0027\u003e\u003cspan style=\u0027color:#ffffff;font-size:16px;font-weight:600\u0027\u003eüöÄ Complete MFA Setup Now\u003c/span\u003e\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003ctable width=\u0027100%\u0027 cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 style=\u0027background:#f8f9fa;margin:25px 0;border-radius:6px\u0027\u003e\u003ctr\u003e\u003ctd style=\u0027padding:20px;text-align:center\u0027\u003e\u003ch4 style=\u0027color:#333;margin:0 0 15px;font-size:16px\u0027\u003eüì≤ Download Microsoft Authenticator:\u003c/h4\u003e\u003ca href=\u0027https://apps.apple.com/app/microsoft-authenticator/id983156458\u0027 target=\u0027_blank\u0027 style=\u0027display:inline-block;margin:5px 8px\u0027\u003e\u003cimg src=\u0027https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg\u0027 alt=\u0027App Store\u0027 style=\u0027height:45px;width:auto\u0027/\u003e\u003c/a\u003e\u003ca href=\u0027https://play.google.com/store/apps/details?id=com.azure.authenticator\u0027 target=\u0027_blank\u0027 style=\u0027display:inline-block;margin:5px 8px\u0027\u003e\u003cimg src=\u0027https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png\u0027 alt=\u0027Google Play\u0027 style=\u0027height:45px;width:auto\u0027/\u003e\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003cp style=\u0027font-size:15px;line-height:1.6;color:#555;margin:20px 0 0\u0027\u003eIf you have any questions or need assistance, please contact the IT Security Team.\u003c/p\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\u0027background:#f8f9fa;padding:20px;text-align:center;color:#888;font-size:13px\u0027\u003eThis is an automated message from IT Security Team\u003cbr\u003e¬© @{utcNow(\u0027yyyy\u0027)} Your Organization. All rights reserved.\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/body\u003e\u003c/html\u003e",
                                                                                                                                                                                                                                                                                                                                              "Importance":  "High"
                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                 "path":  "/v2/SharedMailbox/Mail"
                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                      "Update_Last_Reminder_Date":  {
                                                                                                                                                                                                                                                                                                                        "type":  "ApiConnection",
                                                                                                                                                                                                                                                                                                                        "inputs":  {
                                                                                                                                                                                                                                                                                                                                       "host":  {
                                                                                                                                                                                                                                                                                                                                                    "connection":  {
                                                                                                                                                                                                                                                                                                                                                                       "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                       "method":  "patch",
                                                                                                                                                                                                                                                                                                                                       "body":  {
                                                                                                                                                                                                                                                                                                                                                    "LastReminderDate":  "@{utcNow()}",
                                                                                                                                                                                                                                                                                                                                                    "ReminderCount":  "@add(item()?[\u0027ReminderCount\u0027], 1)"
                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                       "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                                                                                                                                                   },
                                                                                                                                                                                                                                                                                                                        "runAfter":  {
                                                                                                                                                                                                                                                                                                                                         "Send_reminder_email":  [
                                                                                                                                                                                                                                                                                                                                                                     "Succeeded"
                                                                                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                      "else":  {
                                                                                                                                                                                                                                                                                   "actions":  {

                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                   },
                                                                                                                                                                                                          "runAfter":  {
                                                                                                                                                                                                                           "Update_MFA_Not_Registered":  [
                                                                                                                                                                                                                                                             "Succeeded"
                                                                                                                                                                                                                                                         ]
                                                                                                                                                                                                                       }
                                                                                                                                                                                                      }
                                                                                                                                                                         }
                                                                                                                                                         }
                                                                                                                                            }
                                                                                                            },
                                                                                                "else":  {
                                                                                                             "actions":  {
                                                                                                                             "For_Each_MFA_Method":  {
                                                                                                                                                         "type":  "Foreach",
                                                                                                                                                         "foreach":  "@body(\u0027Parse_MFA_Methods\u0027)?[\u0027value\u0027]",
                                                                                                                                                         "actions":  {
                                                                                                                                                                         "Determine_Method_Type":  {
                                                                                                                                                                                                       "type":  "Switch",
                                                                                                                                                                                                       "expression":  "@items(\u0027For_Each_MFA_Method\u0027)[\u0027@odata.type\u0027]",
                                                                                                                                                                                                       "cases":  {
                                                                                                                                                                                                                     "Phone":  {
                                                                                                                                                                                                                                   "case":  "#microsoft.graph.phoneAuthenticationMethod",
                                                                                                                                                                                                                                   "actions":  {
                                                                                                                                                                                                                                                   "Delete_Phone":  {
                                                                                                                                                                                                                                                                        "type":  "Http",
                                                                                                                                                                                                                                                                        "inputs":  {
                                                                                                                                                                                                                                                                                       "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/phoneMethods/@{items(\u0027For_Each_MFA_Method\u0027)[\u0027id\u0027]}",
                                                                                                                                                                                                                                                                                       "method":  "DELETE",
                                                                                                                                                                                                                                                                                       "authentication":  {
                                                                                                                                                                                                                                                                                                              "type":  "ManagedServiceIdentity",
                                                                                                                                                                                                                                                                                                              "audience":  "https://graph.microsoft.com"
                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                               },
                                                                                                                                                                                                                     "Authenticator":  {
                                                                                                                                                                                                                                           "case":  "#microsoft.graph.microsoftAuthenticatorAuthenticationMethod",
                                                                                                                                                                                                                                           "actions":  {
                                                                                                                                                                                                                                                           "Delete_Authenticator":  {
                                                                                                                                                                                                                                                                                        "type":  "Http",
                                                                                                                                                                                                                                                                                        "inputs":  {
                                                                                                                                                                                                                                                                                                       "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/microsoftAuthenticatorMethods/@{items(\u0027For_Each_MFA_Method\u0027)[\u0027id\u0027]}",
                                                                                                                                                                                                                                                                                                       "method":  "DELETE",
                                                                                                                                                                                                                                                                                                       "authentication":  {
                                                                                                                                                                                                                                                                                                                              "type":  "ManagedServiceIdentity",
                                                                                                                                                                                                                                                                                                                              "audience":  "https://graph.microsoft.com"
                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                     "OATH":  {
                                                                                                                                                                                                                                  "case":  "#microsoft.graph.softwareOathAuthenticationMethod",
                                                                                                                                                                                                                                  "actions":  {
                                                                                                                                                                                                                                                  "Delete_OATH":  {
                                                                                                                                                                                                                                                                      "type":  "Http",
                                                                                                                                                                                                                                                                      "inputs":  {
                                                                                                                                                                                                                                                                                     "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/softwareOathMethods/@{items(\u0027For_Each_MFA_Method\u0027)[\u0027id\u0027]}",
                                                                                                                                                                                                                                                                                     "method":  "DELETE",
                                                                                                                                                                                                                                                                                     "authentication":  {
                                                                                                                                                                                                                                                                                                            "type":  "ManagedServiceIdentity",
                                                                                                                                                                                                                                                                                                            "audience":  "https://graph.microsoft.com"
                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                              },
                                                                                                                                                                                                                     "FIDO2":  {
                                                                                                                                                                                                                                   "case":  "#microsoft.graph.fido2AuthenticationMethod",
                                                                                                                                                                                                                                   "actions":  {
                                                                                                                                                                                                                                                   "Delete_FIDO2":  {
                                                                                                                                                                                                                                                                        "type":  "Http",
                                                                                                                                                                                                                                                                        "inputs":  {
                                                                                                                                                                                                                                                                                       "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/fido2Methods/@{items(\u0027For_Each_MFA_Method\u0027)[\u0027id\u0027]}",
                                                                                                                                                                                                                                                                                       "method":  "DELETE",
                                                                                                                                                                                                                                                                                       "authentication":  {
                                                                                                                                                                                                                                                                                                              "type":  "ManagedServiceIdentity",
                                                                                                                                                                                                                                                                                                              "audience":  "https://graph.microsoft.com"
                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                               },
                                                                                                                                                                                                                     "WindowsHello":  {
                                                                                                                                                                                                                                          "case":  "#microsoft.graph.windowsHelloForBusinessAuthenticationMethod",
                                                                                                                                                                                                                                          "actions":  {
                                                                                                                                                                                                                                                          "Delete_WindowsHello":  {
                                                                                                                                                                                                                                                                                      "type":  "Http",
                                                                                                                                                                                                                                                                                      "inputs":  {
                                                                                                                                                                                                                                                                                                     "uri":  "https://graph.microsoft.com/v1.0/users/@{body(\u0027Get_user\u0027)?[\u0027id\u0027]}/authentication/windowsHelloForBusinessMethods/@{items(\u0027For_Each_MFA_Method\u0027)[\u0027id\u0027]}",
                                                                                                                                                                                                                                                                                                     "method":  "DELETE",
                                                                                                                                                                                                                                                                                                     "authentication":  {
                                                                                                                                                                                                                                                                                                                            "type":  "ManagedServiceIdentity",
                                                                                                                                                                                                                                                                                                                            "audience":  "https://graph.microsoft.com"
                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                 },
                                                                                                                                                                                                       "default":  {
                                                                                                                                                                                                                       "actions":  {

                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                   }
                                                                                                                                                                                                   }
                                                                                                                                                                     }
                                                                                                                                                     },
                                                                                                                             "Update_MFA_Not_Registered_After_Reset":  {
                                                                                                                                                                           "type":  "ApiConnection",
                                                                                                                                                                           "inputs":  {
                                                                                                                                                                                          "host":  {
                                                                                                                                                                                                       "connection":  {
                                                                                                                                                                                                                          "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                      }
                                                                                                                                                                                                   },
                                                                                                                                                                                          "method":  "patch",
                                                                                                                                                                                          "body":  {
                                                                                                                                                                                                       "MFARegistrationState":  {
                                                                                                                                                                                                                                    "Value":  "Not Registered"
                                                                                                                                                                                                                                },
                                                                                                                                                                                                       "InGroup":  false
                                                                                                                                                                                                   },
                                                                                                                                                                                          "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                      },
                                                                                                                                                                           "runAfter":  {
                                                                                                                                                                                            "For_Each_MFA_Method":  [
                                                                                                                                                                                                                        "Succeeded",
                                                                                                                                                                                                                        "Failed",
                                                                                                                                                                                                                        "Skipped"
                                                                                                                                                                                                                    ]
                                                                                                                                                                                        }
                                                                                                                                                                       },
                                                                                                                             "Check_if_first_email_after_reset":  {
                                                                                                                                                                      "type":  "If",
                                                                                                                                                                      "expression":  {
                                                                                                                                                                                         "and":  [
                                                                                                                                                                                                     {
                                                                                                                                                                                                         "equals":  [
                                                                                                                                                                                                                        "@item()?[\u0027InviteStatus\u0027]?[\u0027Value\u0027]",
                                                                                                                                                                                                                        "Pending"
                                                                                                                                                                                                                    ]
                                                                                                                                                                                                     }
                                                                                                                                                                                                 ]
                                                                                                                                                                                     },
                                                                                                                                                                      "actions":  {
                                                                                                                                                                                      "Send_initial_email_after_reset":  {
                                                                                                                                                                                                                             "type":  "ApiConnection",
                                                                                                                                                                                                                             "inputs":  {
                                                                                                                                                                                                                                            "host":  {
                                                                                                                                                                                                                                                         "connection":  {
                                                                                                                                                                                                                                                                            "name":  "@parameters(\u0027$connections\u0027)[\u0027office365-1\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                            "method":  "post",
                                                                                                                                                                                                                                            "body":  {
                                                                                                                                                                                                                                                         "MailboxAddress":  "MFA-Registration@andykemp.com",
                                                                                                                                                                                                                                                         "To":  "@{item()?[\u0027Title\u0027]}",
                                                                                                                                                                                                                                                         "Subject":  "üîí Action Required: Set Up Multi-Factor Authentication (MFA)",
                                                                                                                                                                                                                                                         "Body":  "\u003chtml\u003e\u003chead\u003e\u003cstyle\u003ebody{font-family:\u0027Segoe UI\u0027,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background-color:#f4f4f4}.container{max-width:600px;margin:40px auto;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.logo-header{background:#fff;padding:15px;text-align:center;border-bottom:1px solid #e0e0e0}.logo-header img{max-width:200px;height:auto}.header{background:#0078D4;padding:30px 20px;text-align:center}.header h1{color:#fff;margin:0;font-size:26px;font-weight:600}.content{padding:30px 30px 20px}.greeting{font-size:16px;color:#333;margin-bottom:15px}.message{font-size:15px;line-height:1.6;color:#555;margin-bottom:20px}.deadline-box{background:#ffe8e8;border-left:4px solid #dc3545;padding:15px 20px;margin:20px 0;border-radius:4px}.deadline-box strong{color:#dc3545}.steps{background:#f8f9fa;padding:20px;border-radius:6px;margin:20px 0}.steps h3{color:#0078D4;margin-top:0;font-size:18px}.steps ol{margin:10px 0;padding-left:20px}.steps li{margin:8px 0;color:#555}.app-links{text-align:center;margin:25px 0;padding:20px;background:#f8f9fa;border-radius:6px}.app-links h4{color:#333;margin-bottom:15px;font-size:16px}.app-links a{display:inline-block;margin:5px 8px;vertical-align:middle}.app-links img{height:45px;width:auto;display:inline-block;vertical-align:middle}.footer{background:#f8f9fa;padding:20px 30px;text-align:center;color:#888;font-size:13px}\u003c/style\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv class=\u0027container\u0027\u003e\u003cdiv class=\u0027logo-header\u0027\u003e\u003cimg src=\u0027https://www.cygnetgroup.com/wp-content/uploads/2015/11/new-news-image.jpg\u0027 alt=\u0027Cygnet Group\u0027/\u003e\u003c/div\u003e\u003cdiv class=\u0027header\u0027\u003e\u003ch1\u003eMulti-Factor Authentication Setup Required\u003c/h1\u003e\u003c/div\u003e\u003cdiv class=\u0027content\u0027\u003e\u003cdiv class=\u0027greeting\u0027\u003eDear \u003cstrong\u003e@{body(\u0027Get_user\u0027)?[\u0027displayName\u0027]}\u003c/strong\u003e,\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eAs part of our commitment to protecting your account and company data, we require all users to enable Multi-Factor Authentication (MFA). This adds an extra layer of security to your account.\u003c/div\u003e\u003cdiv class=\u0027deadline-box\u0027\u003e\u003cstrong\u003e‚è∞ Important:\u003c/strong\u003e Please complete your MFA setup within the next \u003cstrong\u003e7 days\u003c/strong\u003e.\u003c/div\u003e\u003cdiv class=\u0027steps\u0027\u003e\u003ch3\u003eüì± How to Set Up MFA (4 Easy Steps):\u003c/h3\u003e\u003col\u003e\u003cli\u003e\u003cstrong\u003eClick the button below\u003c/strong\u003e to start the setup process\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eDownload Microsoft Authenticator\u003c/strong\u003e on your mobile device (links below)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eFollow the on-screen instructions\u003c/strong\u003e to link your account\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eYou\u0027re done!\u003c/strong\u003e Your account is now secure\u003c/li\u003e\u003c/ol\u003e\u003c/div\u003e\u003cdiv style=\u0027text-align:center;margin:25px 0\u0027\u003e\u003ctable cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;margin:0 auto\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;padding:16px 45px\u0027\u003e\u003ca href=\u0027https://func-mfa-enrol-570670.azurewebsites.net/api/track-mfa-click?user=@{encodeUriComponent(item()?[\u0027Title\u0027])}\u0027 target=\u0027_blank\u0027 style=\u0027font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;display:inline-block\u0027\u003e\u003cspan style=\u0027color:#ffffff;font-size:16px;font-weight:600\u0027\u003eüöÄ Set Up MFA Now\u003c/span\u003e\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/div\u003e\u003cdiv class=\u0027app-links\u0027\u003e\u003ch4\u003eüì≤ Download Microsoft Authenticator:\u003c/h4\u003e\u003ca href=\u0027https://apps.apple.com/app/microsoft-authenticator/id983156458\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg\u0027 alt=\u0027App Store\u0027/\u003e\u003c/a\u003e\u003ca href=\u0027https://play.google.com/store/apps/details?id=com.azure.authenticator\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png\u0027 alt=\u0027Google Play\u0027/\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eIf you have any questions or need assistance, please contact the IT Security Team.\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\u0027footer\u0027\u003eThis is an automated message from IT Security Team\u003cbr\u003e¬© @{utcNow(\u0027yyyy\u0027)} Your Organization. All rights reserved.\u003c/div\u003e\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e",
                                                                                                                                                                                                                                                         "Importance":  "High"
                                                                                                                                                                                                                                                     },
                                                                                                                                                                                                                                            "path":  "/v2/SharedMailbox/Mail"
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                         },
                                                                                                                                                                                      "Update_After_Initial_Email_Reset":  {
                                                                                                                                                                                                                               "type":  "ApiConnection",
                                                                                                                                                                                                                               "inputs":  {
                                                                                                                                                                                                                                              "host":  {
                                                                                                                                                                                                                                                           "connection":  {
                                                                                                                                                                                                                                                                              "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                                              "method":  "patch",
                                                                                                                                                                                                                                              "body":  {
                                                                                                                                                                                                                                                           "InviteStatus":  {
                                                                                                                                                                                                                                                                                "Value":  "Sent"
                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                           "InviteSentDate":  "@{utcNow()}",
                                                                                                                                                                                                                                                           "ReminderCount":  1
                                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                                              "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                               "runAfter":  {
                                                                                                                                                                                                                                                "Send_initial_email_after_reset":  [
                                                                                                                                                                                                                                                                                       "Succeeded"
                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                           }
                                                                                                                                                                                  },
                                                                                                                                                                      "else":  {
                                                                                                                                                                                   "actions":  {
                                                                                                                                                                                                   "Check_if_7_days_passed_after_reset":  {
                                                                                                                                                                                                                                              "type":  "If",
                                                                                                                                                                                                                                              "expression":  {
                                                                                                                                                                                                                                                                 "or":  [
                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                "equals":  [
                                                                                                                                                                                                                                                                                               "@item()?[\u0027LastReminderDate\u0027]",
                                                                                                                                                                                                                                                                                               "@null"
                                                                                                                                                                                                                                                                                           ]
                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                "lessOrEquals":  [
                                                                                                                                                                                                                                                                                                     "@addDays(item()?[\u0027LastReminderDate\u0027], 7)",
                                                                                                                                                                                                                                                                                                     "@utcNow()"
                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                        ]
                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                              "actions":  {
                                                                                                                                                                                                                                                              "Send_reminder_email_after_reset":  {
                                                                                                                                                                                                                                                                                                      "type":  "ApiConnection",
                                                                                                                                                                                                                                                                                                      "inputs":  {
                                                                                                                                                                                                                                                                                                                     "host":  {
                                                                                                                                                                                                                                                                                                                                  "connection":  {
                                                                                                                                                                                                                                                                                                                                                     "name":  "@parameters(\u0027$connections\u0027)[\u0027office365-1\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                     "method":  "post",
                                                                                                                                                                                                                                                                                                                     "body":  {
                                                                                                                                                                                                                                                                                                                                  "MailboxAddress":  "MFA-Registration@andykemp.com",
                                                                                                                                                                                                                                                                                                                                  "To":  "@{item()?[\u0027Title\u0027]}",
                                                                                                                                                                                                                                                                                                                                  "Subject":  "‚ö†Ô∏è Reminder #@{item()?[\u0027ReminderCount\u0027]}: MFA Setup Still Pending",
                                                                                                                                                                                                                                                                                                                                  "Body":  "\u003chtml\u003e\u003chead\u003e\u003cstyle\u003ebody{font-family:\u0027Segoe UI\u0027,Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background-color:#f4f4f4}.container{max-width:600px;margin:40px auto;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.logo-header{background:#fff;padding:15px;text-align:center;border-bottom:1px solid #e0e0e0}.logo-header img{max-width:200px;height:auto}.header{background:#0078D4;padding:30px 20px;text-align:center}.header h1{color:#fff;margin:0;font-size:26px;font-weight:600}.content{padding:30px 30px 20px}.greeting{font-size:16px;color:#333;margin-bottom:15px}.message{font-size:15px;line-height:1.6;color:#555;margin-bottom:20px}.deadline-box{background:#ffe8e8;border-left:4px solid #dc3545;padding:15px 20px;margin:20px 0;border-radius:4px}.deadline-box strong{color:#dc3545}.steps{background:#f8f9fa;padding:20px;border-radius:6px;margin:20px 0}.steps h3{color:#0078D4;margin-top:0;font-size:18px}.steps ol{margin:10px 0;padding-left:20px}.steps li{margin:8px 0;color:#555}.app-links{text-align:center;margin:25px 0;padding:20px;background:#f8f9fa;border-radius:6px}.app-links h4{color:#333;margin-bottom:15px;font-size:16px}.app-links a{display:inline-block;margin:5px 8px;vertical-align:middle}.app-links img{height:45px;width:auto;display:inline-block;vertical-align:middle}.footer{background:#f8f9fa;padding:20px 30px;text-align:center;color:#888;font-size:13px}.reminder-badge{background:#0078D4;color:#fff;padding:5px 15px;border-radius:20px;display:inline-block;font-size:14px;font-weight:600;margin-bottom:15px}\u003c/style\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv class=\u0027container\u0027\u003e\u003cdiv class=\u0027logo-header\u0027\u003e\u003cimg src=\u0027https://www.cygnetgroup.com/wp-content/uploads/2015/11/new-news-image.jpg\u0027 alt=\u0027Cygnet Group\u0027/\u003e\u003c/div\u003e\u003cdiv class=\u0027header\u0027\u003e\u003ch1\u003eMFA Setup Reminder\u003c/h1\u003e\u003c/div\u003e\u003cdiv class=\u0027content\u0027\u003e\u003cdiv style=\u0027text-align:center\u0027\u003e\u003cspan class=\u0027reminder-badge\u0027\u003eReminder #@{item()?[\u0027ReminderCount\u0027]}\u003c/span\u003e\u003c/div\u003e\u003cdiv class=\u0027greeting\u0027\u003eDear \u003cstrong\u003e@{body(\u0027Get_user\u0027)?[\u0027displayName\u0027]}\u003c/strong\u003e,\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eWe noticed that you have not yet completed your Multi-Factor Authentication (MFA) setup. Securing your account is critical for protecting company data and your personal information.\u003c/div\u003e\u003cdiv class=\u0027deadline-box\u0027\u003e\u003cstrong\u003e‚è∞ Important:\u003c/strong\u003e Your MFA setup was due \u003cstrong\u003e7 days ago\u003c/strong\u003e. Please complete this setup immediately to maintain access to company resources.\u003c/div\u003e\u003cdiv class=\u0027steps\u0027\u003e\u003ch3\u003eüì± Quick Setup Guide:\u003c/h3\u003e\u003col\u003e\u003cli\u003e\u003cstrong\u003eClick the button below\u003c/strong\u003e to begin\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eDownload Microsoft Authenticator\u003c/strong\u003e (if not already installed)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eScan the QR code\u003c/strong\u003e with your phone\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eComplete verification\u003c/strong\u003e - Done in 2 minutes!\u003c/li\u003e\u003c/ol\u003e\u003c/div\u003e\u003cdiv style=\u0027text-align:center;margin:25px 0\u0027\u003e\u003ctable cellpadding=\u00270\u0027 cellspacing=\u00270\u0027 border=\u00270\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;margin:0 auto\u0027\u003e\u003ctr\u003e\u003ctd align=\u0027center\u0027 bgcolor=\u0027#0078D4\u0027 style=\u0027border-radius:30px;padding:16px 45px\u0027\u003e\u003ca href=\u0027https://func-mfa-enrol-570670.azurewebsites.net/api/track-mfa-click?user=@{encodeUriComponent(item()?[\u0027Title\u0027])}\u0027 target=\u0027_blank\u0027 style=\u0027font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;display:inline-block\u0027\u003e\u003cspan style=\u0027color:#ffffff;font-size:16px;font-weight:600\u0027\u003eüöÄ Complete MFA Setup Now\u003c/span\u003e\u003c/a\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003c/div\u003e\u003cdiv class=\u0027app-links\u0027\u003e\u003ch4\u003eüì≤ Download Microsoft Authenticator:\u003c/h4\u003e\u003ca href=\u0027https://apps.apple.com/app/microsoft-authenticator/id983156458\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg\u0027 alt=\u0027App Store\u0027/\u003e\u003c/a\u003e\u003ca href=\u0027https://play.google.com/store/apps/details?id=com.azure.authenticator\u0027 target=\u0027_blank\u0027\u003e\u003cimg src=\u0027https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png\u0027 alt=\u0027Google Play\u0027/\u003e\u003c/a\u003e\u003c/div\u003e\u003cdiv class=\u0027message\u0027\u003eIf you have any questions or need assistance, please contact the IT Security Team.\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\u0027footer\u0027\u003eThis is an automated message from IT Security Team\u003cbr\u003e¬© @{utcNow(\u0027yyyy\u0027)} Your Organization. All rights reserved.\u003c/div\u003e\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e",
                                                                                                                                                                                                                                                                                                                                  "Importance":  "High"
                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                     "path":  "/v2/SharedMailbox/Mail"
                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                              "Update_Last_Reminder_Date_After_Reset":  {
                                                                                                                                                                                                                                                                                                            "type":  "ApiConnection",
                                                                                                                                                                                                                                                                                                            "inputs":  {
                                                                                                                                                                                                                                                                                                                           "host":  {
                                                                                                                                                                                                                                                                                                                                        "connection":  {
                                                                                                                                                                                                                                                                                                                                                           "name":  "@parameters(\u0027$connections\u0027)[\u0027sharepointonline\u0027][\u0027connectionId\u0027]"
                                                                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                           "method":  "patch",
                                                                                                                                                                                                                                                                                                                           "body":  {
                                                                                                                                                                                                                                                                                                                                        "LastReminderDate":  "@{utcNow()}",
                                                                                                                                                                                                                                                                                                                                        "ReminderCount":  "@add(item()?[\u0027ReminderCount\u0027], 1)"
                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                           "path":  "/datasets/@{encodeURIComponent(encodeURIComponent(\u0027https://kempy.sharepoint.com/sites/MFAOps\u0027))}/tables/@{encodeURIComponent(encodeURIComponent(\u0027b2ffafcf-187c-40d9-8657-c2bb84cbd8c9\u0027))}/items/@{encodeURIComponent(item()?[\u0027ID\u0027])}"
                                                                                                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                                                                                                            "runAfter":  {
                                                                                                                                                                                                                                                                                                                             "Send_reminder_email_after_reset":  [
                                                                                                                                                                                                                                                                                                                                                                     "Succeeded"
                                                                                                                                                                                                                                                                                                                                                                 ]
                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                              "else":  {
                                                                                                                                                                                                                                                           "actions":  {

                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                          }
                                                                                                                                                                                               }
                                                                                                                                                                               },
                                                                                                                                                                      "runAfter":  {
                                                                                                                                                                                       "Update_MFA_Not_Registered_After_Reset":  [
                                                                                                                                                                                                                                     "Succeeded"
                                                                                                                                                                                                                                 ]
                                                                                                                                                                                   }
                                                                                                                                                                  }
                                                                                                                         }
                                                                                                         },
                                                                                                "runAfter":  {
                                                                                                                 "Update_Last_Checked":  [
                                                                                                                                             "Succeeded"
                                                                                                                                         ],
                                                                                                                 "Check_Group_Membership":  [
                                                                                                                                                "Succeeded",
                                                                                                                                                "Failed"
                                                                                                                                            ]
                                                                                                             }
                                                                                            }
                                                      },
                                          "runAfter":  {
                                                           "Get_items":  [
                                                                             "Succeeded"
                                                                         ]
                                                       }
                                      }
                },
    "outputs":  {

                },
    "parameters":  {
                       "$connections":  {
                                            "type":  "Object",
                                            "defaultValue":  {

                                                             }
                                        }
                   }
}

